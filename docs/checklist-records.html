
<!doctype html>
<html lang="tr" class="layout-menu-fixed layout-compact" data-assets-path="assets/" data-template="vertical-menu-template-free">
  <head>
    <script>
  // Kullanıcı giriş kontrolü
  (function() {
    const ad = localStorage.getItem("displayName");
    if (!ad) {
      // Giriş yapılmamışsa login sayfasına yönlendir
      window.location.href = "login.html";
    }
  })();
</script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <title>CGV Mars | Checklist Portal</title>
    <link rel="icon" type="image/x-icon" href="assets/img/favicon/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="assets/vendor/fonts/iconify-icons.css" />
    <link rel="stylesheet" href="assets/vendor/css/core.css" />
    <link rel="stylesheet" href="assets/css/demo.css" />
    <link rel="stylesheet" href="assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="assets/vendor/libs/apex-charts/apex-charts.css" />
    <script src="assets/vendor/js/helpers.js"></script>
    <script src="assets/js/config.js"></script>
    <style>
      .table-actions .btn{ margin-right: .35rem; }
      .badge-flat{ background-color:#f8fafc; border:1px solid #e5e7eb; color:#111; }
      .search-empty{ padding:1rem; color:#888; text-align:center; }
    </style>
  </head>
  <body>
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Sidebar -->
        <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
          <div class="app-brand demo">
            <a href="index.html" class="app-brand-link">
              <span class="app-brand-text menu-text fw-bolder ms-2">CGV Mars | Checklist Portal</span>
            </a>
          </div>
          <div class="menu-inner-shadow"></div>
          <ul class="menu-inner py-1">
            <li class="menu-item">
              <a href="index.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-home"></i>
                <div>Dashboard</div>
              </a>
            </li>
            <li class="menu-item open active">
              <a href="javascript:void(0);" class="menu-link menu-toggle">
                <i class="menu-icon tf-icons bx bx-check-square"></i>
                <div>Checklistler</div>
              </a>
              <ul class="menu-sub">
                <li class="menu-item">
                  <a href="checklist.html" class="menu-link"><div>Checklist Ana Sayfa</div></a>
                </li>
                <li class="menu-item">
                  <a href="checklist-kst.html" class="menu-link"><div>KST Checklist</div></a>
                </li>
                <li class="menu-item active">
                  <a href="checklist-records.html" class="menu-link"><div>Checklist Kayıtları</div></a>
                </li>
              </ul>
            </li>
          </ul>
        </aside>
        <!-- /Sidebar -->

        <div class="layout-page">
          <!-- Navbar -->
          <nav class="layout-navbar container-xxl navbar-detached navbar navbar-expand-xl align-items-center bg-navbar-theme" id="layout-navbar">
            <div class="layout-menu-toggle navbar-nav align-items-xl-center me-4 me-xl-0 d-xl-none">
              <a class="nav-item nav-link px-0 me-xl-6" href="javascript:void(0)"><i class="icon-base bx bx-menu icon-md"></i></a>
            </div>
            <div class="navbar-nav-right d-flex align-items-center justify-content-end" id="navbar-collapse">
              <div class="navbar-nav align-items-center me-auto">
                <div class="nav-item d-flex align-items-center">
                  <span class="w-px-22 h-px-22"><i class="icon-base bx bx-search icon-md"></i></span>
                  <input id="globalSearch" type="text" class="form-control border-0 shadow-none ps-1 ps-sm-2 d-md-block d-none" placeholder="Kayıtlarda ara..." aria-label="Ara..." />
                </div>
              </div>
              <ul class="navbar-nav flex-row align-items-center ms-md-auto">
                <li class="nav-item navbar-dropdown dropdown-user dropdown">
                  <a class="nav-link dropdown-toggle hide-arrow p-0" href="javascript:void(0);" data-bs-toggle="dropdown">
                    <div class="avatar avatar-online">
                      <img src="assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                    </div>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a class="dropdown-item" href="#">
                        <div class="d-flex">
                          <div class="flex-shrink-0 me-3">
                            <div class="avatar avatar-online"><img src="assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" /></div>
                          </div>
                          <div class="flex-grow-1"><h6 class="mb-0">Optimum Gaziemir</h6></div>
                        </div>
                      </a>
                    </li>
                    <li><div class="dropdown-divider my-1"></div></li>
                    <li><a class="dropdown-item" href="#"><i class="icon-base bx bx-user icon-md me-3"></i><span>Profil</span></a></li>
                    <li><a class="dropdown-item" href="#"><i class="icon-base bx bx-cog icon-md me-3"></i><span>Ayarlar</span></a></li>
                    <li>
                      <div class="dropdown-divider my-1"></div>
                    </li>
                      <li>
                        <a class="dropdown-item" href="javascript:void(0);" onclick="logout()">
                          <i class="icon-base bx bx-power-off icon-md me-3"></i><span>Çıkış Yap</span>
                        </a>
                      </li>

                      <script>
                        function logout() {
                          localStorage.removeItem("displayName");
                          window.location.href = "login.html";
                        }
                      </script>
                </li>
              </ul>
            </div>
          </nav>
          <!-- /Navbar -->

          <!-- Content wrapper -->
          <div class="container-xxl flex-grow-1 container-p-y">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="fw-bold mb-0">Checklist Kayıtları</h4>
              <a href="checklist.html" class="btn btn-outline-secondary"><i class="bx bx-arrow-back me-1"></i> Aktif Checklistler</a>
            </div>

            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover align-middle" id="tableRecords">
                    <thead class="table-light">
                      <tr>
                        <th>Checklist</th>
                        <th>Tarih</th>
                        <th>Açılış Sorumlusu</th>
                        <th>Kapanış Sorumlusu</th>
                        <th>Durum</th>
                        <th class="text-center">İşlemler</th>
                      </tr>
                    </thead>
                    <tbody id="recordTable"></tbody>
                  </table>
                  <div id="emptyState" class="search-empty d-none">Kayıt bulunamadı.</div>
                </div>
              </div>
            </div>
          </div>
          <!-- /Content wrapper -->
        </div>
      </div>

      <div class="layout-overlay layout-menu-toggle"></div>
    </div>

    <!-- Core JS -->
    <script src="assets/vendor/libs/jquery/jquery.js"></script>
    <script src="assets/vendor/libs/popper/popper.js"></script>
    <script src="assets/vendor/js/bootstrap.js"></script>
    <script src="assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="assets/vendor/js/menu.js"></script>
    <script src="assets/vendor/libs/apex-charts/apexcharts.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/dashboards-analytics.js"></script>
    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <script>
      (function(){
        "use strict";
        const STORAGE_KEY = "checklistKayitlar";
        const tbody = document.getElementById("recordTable");
        const emptyState = document.getElementById("emptyState");
        const globalSearch = document.getElementById("globalSearch");

        function read(){
          try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch(e){ return []; }
        }
        function badge(txt){ return '<span class="badge badge-flat">'+txt+'</span>'; }
        function durumEtiket(r){
          if (r.kapanisTamam) return '<span class="badge bg-success">Tamamlandı</span>';
          if (r.acilisTamam)  return '<span class="badge bg-warning text-dark">Aktif (Kapanış Bekliyor)</span>';
          // geriye dönük uyumluluk
          const a = (r.acilisSorular||[]).length, k = (r.kapanisSorular||[]).length, o = (r.ortak||r.ortakSorular||[]).length;
          if (a>0 && k>0 && o>0) return '<span class="badge bg-success">Tamamlandı</span>';
          if (a>0) return '<span class="badge bg-warning text-dark">Aktif (Kapanış Bekliyor)</span>';
          return '<span class="badge bg-secondary">Taslak</span>';
        }

        function makeRow(rec){
          const ac = rec.acilisSorumlu || rec.acilis || "-";
          const kp = rec.kapanisSorumlusu || rec.kapanis || "-";
          const tr = document.createElement("tr");
          const tarih = rec.tarih || "";
          // Rapor sayfası yeni sekmede (container kilidi yaşamamak için)
          const linkReport = 'checklist-kst-report.html?tarih='+encodeURIComponent(tarih);
          // Formu aç: eğer kapanış bekliyor ise resume=1 parametresi ile
const linkForm   = 'checklist-kst.html?tarih='+encodeURIComponent(tarih)
  + (rec.acilisTamam && !rec.kapanisTamam ? '&resume=1' : '')
  + '&expandAll=1';


          tr.innerHTML = ''
            + '<td>'+badge('KST')+'</td>'
            + '<td>'+ (tarih || '-') +'</td>'
            + '<td>'+ ac +'</td>'
            + '<td>'+ kp +'</td>'
            + '<td>'+ durumEtiket(rec) +'</td>'
            + '<td class="text-center table-actions">'
            +   '<a class="btn btn-sm btn-primary" target="_blank" href="'+linkReport+'"><i class="bx bx-printer me-1"></i> Rapor</a>'
            +   '<a class="btn btn-sm btn-outline-secondary" href="'+linkForm+'"><i class="bx bx-edit-alt me-1"></i> Form</a>'
            + '</td>';
          return tr;
        }

        function render(list){
          tbody.innerHTML = "";
          if(!list || list.length===0){
            emptyState.classList.remove("d-none");
            return;
          }
          emptyState.classList.add("d-none");
          list.forEach(function(r){ tbody.appendChild(makeRow(r)); });
        }

        function load(){
          const data = read();
          data.sort(function(a,b){ return String(b.tarih||'').localeCompare(String(a.tarih||'')); });
          render(data);
          return data;
        }

        // simple filter over rows
        function filterRows(q){
          q = (q||"").toLowerCase();
          const rows = Array.from(tbody.querySelectorAll("tr"));
          let visible = 0;
          rows.forEach(function(tr){
            const txt = tr.textContent.toLowerCase();
            const show = !q || txt.indexOf(q) > -1;
            tr.style.display = show ? "" : "none";
            if(show) visible++;
          });
          emptyState.classList.toggle("d-none", visible !== 0);
        }

        document.addEventListener("DOMContentLoaded", function(){
          load();
          if(globalSearch){
            globalSearch.addEventListener("input", function(){ filterRows(globalSearch.value); });
          }
        });
      })();
    </script>
  </body>
</html>

